<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Mi Perfil | Akalia</title>
  <%- include('../partials/head.ejs'); %>
    <link rel="stylesheet" href="/styles/usuario-perfil.css"><!-- Crea este archivo para estilos personalizados -->
</head>

<body class="h-100 m-0 d-flex flex-column vh-100 bg-blanco-light">
  <%- include('../partials/navbar.ejs'); %>
    <div class="d-flex flex-row h-100">
      <%- include('../partials/sidebar.ejs'); %>
        <main class="flex-grow-1 d-flex flex-column justify-content-center align-items-center py-5">

          <!-- Mostrar mensaje de error de carga si existe -->
          <% if (typeof errorCarga !=='undefined' && errorCarga) { %>
            <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.2rem;"></i>
                <div>
                  <strong>Advertencia:</strong>
                  <%= errorCarga %>
                    <br>
                    <small class="text-muted">
                      Los datos mostrados son limitados. Algunos campos como teléfono y fecha de registro pueden no
                      estar disponibles.
                    </small>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
            <% } %>

              <!-- Verificar si existen datos del usuario -->
              <% if (typeof usuario !=='undefined' && usuario) { %>
                <section class="usuario-perfil-card">
                  <h2 class="usuario-perfil-title">Mi Perfil</h2>
                  <div class="usuario-perfil-info">
                    <div class="row mb-3">
                      <div class="col-md-6 mb-3 mb-md-0">
                        <strong class="usuario-perfil-label">Nombres y apellido</strong>
                        <div>
                          <%= usuario.nombreUsuario || 'No disponible' %>
                            <%= usuario.apellidoUsuario || '' %>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <strong class="usuario-perfil-label">Celular</strong>
                        <div>
                          <% if (usuario.telefono && usuario.telefono.includes('Error al cargar')) { %>
                            <span class="text-danger">
                              <i class="fas fa-exclamation-circle me-1"></i>
                              Error al cargar
                            </span>
                            <% } else { %>
                              <%= usuario.telefono || 'No registrado' %>
                                <% } %>
                        </div>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6 mb-3 mb-md-0">
                        <strong class="usuario-perfil-label">Correo</strong>
                        <div>
                          <%= usuario.email || 'No disponible' %>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <strong class="usuario-perfil-label">Contraseña</strong>
                        <div>
                          <%= usuario.contrasena || '********' %>
                        </div>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <div class="col-md-6 mb-3 mb-md-0">
                        <strong class="usuario-perfil-label">Fecha de registro</strong>
                        <div>
                          <!-- Mostrar fecha formateada o fecha original con manejo de errores -->
                          <% if (usuario.fechaRegistro && usuario.fechaRegistro.includes('Error al cargar')) { %>
                            <span class="text-danger">
                              <i class="fas fa-exclamation-circle me-1"></i>
                              Error al cargar
                            </span>
                            <% } else if (usuario.fechaRegistroFormateada) { %>
                              <%= usuario.fechaRegistroFormateada %>
                                <% } else if (usuario.fechaRegistro && usuario.fechaRegistro !=='No disponible' ) { %>
                                  <%= new Date(usuario.fechaRegistro).toLocaleDateString('es-ES') %>
                                    <% } else { %>
                                      <span class="text-muted">No disponible</span>
                                      <% } %>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <strong class="usuario-perfil-label">Estado de cuenta</strong>
                        <div>
                          <% if (usuario.estadoUsuario) { %>
                            <span class="badge <%= usuario.estadoUsuario === 'activo' ? 'bg-success' : 'bg-warning' %>">
                              <%= usuario.estadoUsuario.charAt(0).toUpperCase() + usuario.estadoUsuario.slice(1) %>
                            </span>
                            <% } else { %>
                              <span class="badge bg-secondary">Desconocido</span>
                              <% } %>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-8"></div>
                      <div class="col-md-4 d-flex flex-column align-items-md-end gap-2">

                        <button id="btnEditarPerfil"
                          class="w-100 btn btn-terracota d-flex align-items-center gap-2 px-4 mb-2" type="button"
                          data-id="<%= usuario.idPersona || usuario.id %>">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 28 28"
                            fill="none">
                            <g clip-path="url(#clip0_168_47)">
                              <path
                                d="M21.2555 0.255477C21.3368 0.173992 21.4333 0.109342 21.5396 0.0652303C21.6459 0.021119 21.7599 -0.00158691 21.875 -0.00158691C21.9901 -0.00158691 22.1041 0.021119 22.2104 0.0652303C22.3167 0.109342 22.4132 0.173992 22.4945 0.255477L27.7445 5.50548C27.826 5.58676 27.8906 5.68331 27.9347 5.78962C27.9789 5.89592 28.0016 6.00988 28.0016 6.12498C28.0016 6.24007 27.9789 6.35403 27.9347 6.46034C27.8906 6.56664 27.826 6.6632 27.7445 6.74448L10.2445 24.2445C10.1605 24.3279 10.0605 24.3934 9.9505 24.437L1.2005 27.937C1.04148 28.0006 0.867289 28.0162 0.699505 27.9818C0.531722 27.9474 0.377729 27.8645 0.256618 27.7434C0.135506 27.6222 0.0526026 27.4683 0.0181846 27.3005C-0.0162335 27.1327 -0.000652346 26.9585 0.0629963 26.7995L3.563 18.0495C3.60662 17.9395 3.67211 17.8395 3.7555 17.7555L21.2555 0.255477ZM19.6122 4.37498L23.625 8.38773L25.8877 6.12498L21.875 2.11223L19.6122 4.37498ZM22.3877 9.62498L18.375 5.61223L7 16.9872V17.5H7.875C8.10706 17.5 8.32962 17.5922 8.49371 17.7563C8.65781 17.9204 8.75 18.1429 8.75 18.375V19.25H9.625C9.85706 19.25 10.0796 19.3422 10.2437 19.5063C10.4078 19.6704 10.5 19.8929 10.5 20.125V21H11.0127L22.3877 9.62498ZM5.306 18.6812L5.1205 18.8667L2.4465 25.5535L9.13325 22.8795L9.31875 22.694C9.15183 22.6316 9.00793 22.5198 8.9063 22.3734C8.80466 22.2271 8.75013 22.0532 8.75 21.875V21H7.875C7.64293 21 7.42037 20.9078 7.25628 20.7437C7.09218 20.5796 7 20.357 7 20.125V19.25H6.125C5.94681 19.2498 5.77291 19.1953 5.62656 19.0937C5.4802 18.992 5.36836 18.8481 5.306 18.6812Z"
                                fill="currentColor" />
                            </g>
                            <defs>
                              <clipPath id="clip0_168_47">
                                <rect width="28" height="28" fill="white" />
                              </clipPath>
                            </defs>
                          </svg> Editar
                        </button>

                        <button id="btnEliminarCuenta"
                          class=" w-100 btn btn-basic d-flex align-items-center gap-2 px-4 usuario-perfil-eliminar"
                          type="button" data-id="<%= usuario.idPersona || usuario.id %>">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 28 28"
                            fill="none">
                            <path
                              d="M11.375 1.75H16.625C16.8571 1.75 17.0796 1.84219 17.2437 2.00628C17.4078 2.17038 17.5 2.39294 17.5 2.625V4.375H10.5V2.625C10.5 2.39294 10.5922 2.17038 10.7563 2.00628C10.9204 1.84219 11.1429 1.75 11.375 1.75ZM19.25 4.375V2.625C19.25 1.92881 18.9734 1.26113 18.4812 0.768845C17.9889 0.276562 17.3212 0 16.625 0L11.375 0C10.6788 0 10.0111 0.276562 9.51884 0.768845C9.02656 1.26113 8.75 1.92881 8.75 2.625V4.375H2.625C2.39294 4.375 2.17038 4.46719 2.00628 4.63128C1.84219 4.79538 1.75 5.01794 1.75 5.25C1.75 5.48206 1.84219 5.70462 2.00628 5.86872C2.17038 6.03281 2.39294 6.125 2.625 6.125H3.5665L5.05925 24.78C5.12964 25.6571 5.52782 26.4755 6.17448 27.0722C6.82114 27.6689 7.66884 28.0002 8.54875 28H19.4513C20.3312 28.0002 21.1789 27.6689 21.8255 27.0722C22.4722 26.4755 22.8704 25.6571 22.9408 24.78L24.4335 6.125H25.375C25.6071 6.125 25.8296 6.03281 25.9937 5.86872C26.1578 5.70462 26.25 5.48206 26.25 5.25C26.25 5.01794 26.1578 4.79538 25.9937 4.63128C25.8296 4.46719 25.6071 4.375 25.375 4.375H19.25ZM22.6765 6.125L21.196 24.64C21.1608 25.0785 20.9617 25.4877 20.6384 25.7861C20.3151 26.0845 19.8912 26.2501 19.4513 26.25H8.54875C8.10879 26.2501 7.68495 26.0845 7.36162 25.7861C7.03828 25.4877 6.8392 25.0785 6.804 24.64L5.3235 6.125H22.6765ZM9.57425 7.875C9.80583 7.86161 10.0333 7.94074 10.2065 8.09497C10.3798 8.2492 10.4847 8.46593 10.4983 8.6975L11.3733 23.5725C11.3824 23.8014 11.3015 24.0247 11.1479 24.1946C10.9942 24.3644 10.7801 24.4673 10.5515 24.481C10.3228 24.4948 10.0979 24.4183 9.92503 24.2681C9.75213 24.1179 9.64504 23.9058 9.62675 23.6775L8.75 8.8025C8.7429 8.68755 8.75855 8.57232 8.79608 8.46344C8.8336 8.35455 8.89225 8.25414 8.96867 8.16797C9.04508 8.0818 9.13776 8.01156 9.24138 7.96129C9.345 7.91101 9.45752 7.88169 9.5725 7.875H9.57425ZM18.4258 7.875C18.5407 7.88169 18.6533 7.91101 18.7569 7.96129C18.8605 8.01156 18.9532 8.0818 19.0296 8.16797C19.106 8.25414 19.1646 8.35455 19.2022 8.46344C19.2397 8.57232 19.2554 8.68755 19.2482 8.8025L18.3732 23.6775C18.3686 23.7938 18.3408 23.908 18.2914 24.0134C18.2421 24.1187 18.1722 24.2132 18.0859 24.2913C17.9996 24.3694 17.8986 24.4294 17.7888 24.468C17.679 24.5065 17.5626 24.5228 17.4464 24.5158C17.3303 24.5088 17.2167 24.4787 17.1123 24.4273C17.0079 24.3759 16.9148 24.3042 16.8385 24.2163C16.7621 24.1285 16.7041 24.0263 16.6677 23.9157C16.6314 23.8052 16.6175 23.6885 16.6268 23.5725L17.5018 8.6975C17.5153 8.46593 17.6202 8.2492 17.7935 8.09497C17.9667 7.94074 18.1942 7.86161 18.4258 7.875ZM14 7.875C14.2321 7.875 14.4546 7.96719 14.6187 8.13128C14.7828 8.29538 14.875 8.51794 14.875 8.75V23.625C14.875 23.8571 14.7828 24.0796 14.6187 24.2437C14.4546 24.4078 14.2321 24.5 14 24.5C13.7679 24.5 13.5454 24.4078 13.3813 24.2437C13.2172 24.0796 13.125 23.8571 13.125 23.625V8.75C13.125 8.51794 13.2172 8.29538 13.3813 8.13128C13.5454 7.96719 13.7679 7.875 14 7.875Z"
                              fill="currentColor" />
                          </svg>
                          Eliminar cuenta
                        </button>

                      </div>
                    </div>
                  </div>
                </section>

                <% } else { %>
                  <!-- Mensaje cuando no hay datos de usuario -->
                  <section class="usuario-perfil-card">
                    <h2 class="usuario-perfil-title">Error</h2>
                    <div class="alert alert-warning">
                      <p>No se pudieron cargar los datos del perfil.</p>
                      <a href="/" class="btn btn-primary">Volver al inicio</a>
                    </div>
                  </section>
                  <% } %>

        </main>
    </div>

    <!-- ========================== MODAL PARA EDITAR PERFIL ========================== -->
    <!-- Este modal se abrirá cuando el usuario haga clic en el botón "Editar" -->
    <div class="modal fade" id="modalEditarPerfil" tabindex="-1" aria-labelledby="modalEditarPerfilLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg"> <!-- modal-lg = tamaño grande para más espacio -->
        <div class="modal-content">

          <!-- ENCABEZADO DEL MODAL -->
          <div class="modal-header">
            <h5 class="modal-title" id="modalEditarPerfilLabel">
              <i class="fas fa-edit me-2"></i> Editar Mi Perfil
            </h5>
            <!-- Botón X para cerrar el modal -->
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <!-- CUERPO DEL MODAL - AQUÍ VA EL FORMULARIO -->
          <div class="modal-body">
            <!-- Formulario para editar los datos del usuario -->
            <form id="formEditarPerfil">

              <!-- FILA 1: Nombre y Apellido -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editarNombre" class="form-label">
                    <strong>Nombres</strong>
                  </label>
                  <input type="text" class="form-control" id="editarNombre" name="nombreUsuario"
                    placeholder="Ingresa tu nombre" required>
                </div>
                <div class="col-md-6">
                  <label for="editarApellido" class="form-label">
                    <strong>Apellido</strong>
                  </label>
                  <input type="text" class="form-control" id="editarApellido" name="apellidoUsuario"
                    placeholder="Ingresa tu apellido" required>
                </div>
              </div>

              <!-- FILA 2: Email y Teléfono -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editarEmail" class="form-label">
                    <strong>Correo Electrónico</strong>
                  </label>
                  <input type="email" class="form-control" id="editarEmail" name="email"
                    placeholder="ejemplo@correo.com" required>
                </div>
                <div class="col-md-6">
                  <label for="editarTelefono" class="form-label">
                    <strong>Celular</strong>
                  </label>
                  <input type="tel" class="form-control" id="editarTelefono" name="telefono" placeholder="300 123 4567">
                </div>
              </div>

              <!-- FILA 3: Contraseña (opcional) -->
              <div class="row mb-3">
                <div class="col-12">
                  <label for="editarContrasena" class="form-label">
                    <strong>Nueva Contraseña</strong>
                    <small class="text-muted">(Déjala vacía si no quieres cambiarla)</small>
                  </label>
                  <input type="password" class="form-control" id="editarContrasena" name="contrasena"
                    placeholder="Ingresa una nueva contraseña (opcional)">
                </div>
              </div>

              <!-- MENSAJE DE ESTADO (se mostrará cuando haya errores o éxito) -->
              <div id="mensajeEstadoModal" class="alert d-none" role="alert"></div>

            </form>
          </div>

          <!-- PIE DEL MODAL - BOTONES DE ACCIÓN -->
          <div class="modal-footer">
            <!-- Botón para cancelar y cerrar el modal -->
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <!-- Botón para guardar los cambios -->
            <button type="button" class="btn btn-terracota" id="btnGuardarCambios">
              <i class="fas fa-save me-1"></i> Guardar Cambios
            </button>
          </div>

        </div>
      </div>
    </div>
    <!-- ======================== FIN DEL MODAL EDITAR PERFIL ======================= -->

    <!-- ======================== MODAL PARA ELIMINAR CUENTA ======================== -->
    <!-- Este modal se abrirá cuando el usuario haga clic en el botón "Eliminar cuenta" -->
    <div class="modal fade" id="modalEliminarCuenta" tabindex="-1" aria-labelledby="modalEliminarCuentaLabel"
      aria-hidden="true">
      <div class="modal-dialog"> <!-- Tamaño normal para esta modal más pequeña -->
        <div class="modal-content border-danger"> <!-- Borde rojo para indicar peligro -->

          <!-- ENCABEZADO DEL MODAL CON ESTILO DE PELIGRO -->
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalEliminarCuentaLabel">
              <i class="fas fa-exclamation-triangle me-2"></i> ¡Eliminar Cuenta!
            </h5>
            <!-- Botón X para cerrar el modal -->
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
              aria-label="Cerrar"></button>
          </div>

          <!-- CUERPO DEL MODAL CON INFORMACIÓN DE ADVERTENCIA -->
          <div class="modal-body">

            <!-- PASO 1: Primera advertencia general -->
            <div id="pasoUnoEliminacion" class="text-center">
              <div class="mb-4">
                <!-- Icono grande de advertencia -->
                <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
              </div>

              <h4 class="text-danger mb-3">¡ADVERTENCIA!</h4>

              <div class="alert alert-warning" role="alert">
                <strong>¿Estás seguro de que deseas eliminar tu cuenta?</strong>
                <hr>
                <ul class="text-start mb-0">
                  <li>Tu cuenta será desactivada permanentemente</li>
                  <li>No podrás acceder a tu perfil ni tus datos</li>
                  <li>Perderás acceso a todos tus emprendimientos</li>
                  <li>Esta acción NO se puede deshacer fácilmente</li>
                </ul>
              </div>
            </div>

            <!-- PASO 2: Confirmación final -->
            <div id="pasoDosEliminacion" class="text-center d-none">
              <div class="mb-4">
                <!-- Icono grande de peligro -->
                <i class="fas fa-user-xmark text-danger" style="font-size: 4rem;"></i>
              </div>

              <h4 class="text-danger mb-3">CONFIRMACIÓN</h4>

              <div class="alert alert-danger" role="alert">
                <strong>ELIMINACIÓN CUENTA</strong>
                <hr>
                <p class="mb-0">
                  Tu cuenta "<strong>
                    <%= usuario.nombreUsuario %>
                      <%= usuario.apellidoUsuario %>
                  </strong>" será eliminada de forma permanente.
                </p>
              </div>

              <!-- CAMPO PARA INGRESAR CONTRASEÑA COMO CONFIRMACIÓN -->
              <div class="mb-3">
                <label for="confirmarContrasenaEliminacion" class="form-label">
                  <strong>Para confirmar la eliminación, ingresa tu <span class="text-danger">contraseña
                      actual</span></strong>
                </label>
                <div class="input-group">
                  <input type="password" class="form-control" id="confirmarContrasenaEliminacion"
                    placeholder="Ingresa tu contraseña actual" autocomplete="current-password" required>
                  <!-- Botón para mostrar/ocultar contraseña -->
                  <button class="btn btn-outline-secondary" type="button" id="mostrarContrasenaEliminacion"
                    title="Mostrar/Ocultar contraseña">
                    <i class="fas fa-eye" id="iconoOjoContrasena"></i>
                  </button>
                </div>
                <small class="text-muted">
                  <i class="fas fa-shield-alt me-1"></i>
                  Por seguridad, necesitamos verificar que eres el propietario de la cuenta
                </small>
              </div>
            </div>

            <!-- MENSAJE DE ESTADO DE LA ELIMINACIÓN -->
            <div id="mensajeEstadoEliminacion" class="alert d-none" role="alert"></div>

          </div>

          <!-- PIE DEL MODAL - BOTONES DINÁMICOS SEGÚN EL PASO -->
          <div class="modal-footer">

            <!-- BOTONES PARA EL PASO 1 -->
            <div id="botonesPasoUno">
              <!-- Botón para cancelar (siempre disponible) -->
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i> Cancelar
              </button>
              <!-- Botón para continuar al paso 2 -->
              <button type="button" class="btn btn-warning" id="btnContinuarEliminacion">
                <i class="fas fa-arrow-right me-1"></i> Continuar
              </button>
            </div>

            <!-- BOTONES PARA EL PASO 2 (inicialmente ocultos) -->
            <div id="botonesPasoDos" class="d-none">
              <!-- Botón para volver al paso 1 -->
              <button type="button" class="btn btn-secondary" id="btnVolverPasoUno">
                <i class="fas fa-arrow-left me-1"></i> Volver
              </button>
              <!-- Botón final para eliminar cuenta -->
              <button type="button" class="btn btn-danger" id="btnEliminarDefinitivo">
                <i class="fas fa-trash-alt me-1"></i> Eliminar Cuenta
              </button>
            </div>

          </div>

        </div>
      </div>
    </div>
    <!-- ============================= FIN DEL MODAL DE ELIMINACIÓN ============================= -->

    <%- include('../partials/footer.ejs'); %>

      <!-- DATOS DEL USUARIO COMO ATRIBUTOS DATA -->
      <!-- Los datos se pasan como atributos data- en un elemento HTML oculto -->
      <% if (typeof usuario !=='undefined' && usuario) { %>
        <div id="datosUsuarioParaJS" data-id-persona="<%= usuario.idPersona || '' %>"
          data-nombre-usuario="<%= usuario.nombreUsuario || '' %>"
          data-apellido-usuario="<%= usuario.apellidoUsuario || '' %>" data-email="<%= usuario.email || '' %>"
          data-telefono="<%= usuario.telefono || '' %>" data-estado-usuario="<%= usuario.estadoUsuario || '' %>"
          style="display: none;">
        </div>
        <% } %>

          <script src="/js/perfilUsuario.js"></script>
          <script src="/lib/js/bootstrap.min.js.map"></script>
          <script src="/lib/js/bootstrap.bundle.min.js"></script>
          <script src="/js/login_signup.js"></script>
          <!-- Bootstrap + FontAwesome -->
          <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>

</html>